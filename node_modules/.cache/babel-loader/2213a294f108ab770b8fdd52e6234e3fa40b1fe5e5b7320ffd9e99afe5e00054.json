{"ast":null,"code":"import { toHex, logStr } from \"../resources/Helpers.js\";\nimport { ROM } from \"../stores/ROM.js\";\nimport { WPC } from \"../resources/Constants.js\";\nexport class Checksum {\n  static get stored() {\n    return ROM.byteAtAddr(ROM.nonPagedBankAddr + WPC.ChecksumOffset) * 256 + ROM.byteAtAddr(ROM.nonPagedBankAddr + WPC.ChecksumOffset + 1);\n  }\n  static _getRomDelta() {\n    return ROM.byteAtAddr(ROM.nonPagedBankAddr + WPC.DeltaOffset) * 256 + ROM.byteAtAddr(ROM.nonPagedBankAddr + WPC.DeltaOffset + 1);\n  }\n  static get calculated() {\n    let checksum = 0;\n    for (let i = 0; i < ROM.size; i++) {\n      checksum += ROM.byteAtAddr(i);\n    }\n    checksum %= 65536;\n    return checksum;\n  }\n  static get delta() {\n    return this._getRomDelta();\n  }\n  static _byteSumOf16bitVal(value) {\n    value &= 0xFFFF;\n    const highByte = value >> 8 & 0xFF;\n    const lowByte = value & 0xFF;\n    return highByte + lowByte;\n  }\n  static _subtractChecksumAndDeltaBytes(checksum) {\n    const romDelta = this._getRomDelta();\n    const storedChecksum = this.stored;\n    return checksum - this._byteSumOf16bitVal(romDelta) - this._byteSumOf16bitVal(storedChecksum);\n  }\n  static disable() {\n    const romDelta = this._getRomDelta();\n    const romData = ROM.data;\n    let status = 0;\n    if (romDelta != 0x00FF) {\n      romData.set([0x00, 0xFF], ROM.nonPagedBankAddr + WPC.DeltaOffset);\n      status = 1;\n      logStr(\"ROM modified to disable checksum.\");\n    }\n    return {\n      data: romData,\n      status: status\n    };\n  }\n  static update(version, force = false) {\n    version &= version;\n    version = parseInt(version.toString(), 16);\n    const romData = ROM.data;\n    const clearedChecksum = this._subtractChecksumAndDeltaBytes(this.calculated);\n    let newChecksum = 0;\n    let newDelta = 0;\n    let checksumFound = false;\n    let status = 0;\n    if (this.stored == this.calculated && version == (this.stored & 0xFF) && !force) {\n      logStr(\"The checksum of the ROM is correct, no need to update\");\n      status = 0;\n    } else {\n      logStr(\"Trying to figure out a new checksum and delta\");\n      for (let delta = this.delta; delta < 0xFFFF && !checksumFound; delta++) {\n        if (delta == 0x00FF) {\n          delta = 0x2345;\n        }\n        for (let highByte = 0; highByte < 0xFF && !checksumFound; highByte++) {\n          const checksum = (highByte << 8) + version;\n          if (clearedChecksum + this._byteSumOf16bitVal(delta) + highByte + version == checksum) {\n            checksumFound = true;\n            newChecksum = checksum;\n            newDelta = delta;\n            romData.set([newDelta >> 8 & 0xFF, newDelta & 0xFF], ROM.nonPagedBankAddr + WPC.DeltaOffset);\n            romData.set([newChecksum >> 8 & 0xFF, newChecksum & 0xFF], ROM.nonPagedBankAddr + WPC.ChecksumOffset);\n            logStr(`New checksum is ${toHex(newChecksum)} and delta is ${toHex(newDelta)}`);\n            status = 1;\n          }\n        }\n      }\n      if (!checksumFound) {\n        logStr(`Error: Could not figure out a new checksum`);\n        status = -1;\n      }\n    }\n    return {\n      data: romData,\n      status: status\n    };\n  }\n  static get isValid() {\n    return this.calculated == this.stored;\n  }\n}","map":{"version":3,"names":["toHex","logStr","ROM","WPC","Checksum","stored","byteAtAddr","nonPagedBankAddr","ChecksumOffset","_getRomDelta","DeltaOffset","calculated","checksum","i","size","delta","_byteSumOf16bitVal","value","highByte","lowByte","_subtractChecksumAndDeltaBytes","romDelta","storedChecksum","disable","romData","data","status","set","update","version","force","parseInt","toString","clearedChecksum","newChecksum","newDelta","checksumFound","isValid"],"sources":["/Users/permartinson/Documents/GitHub/wpcedit-vue/node_modules/wpcedit/dist/classes/Checksum.js"],"sourcesContent":["import { toHex, logStr } from \"../resources/Helpers.js\";\nimport { ROM } from \"../stores/ROM.js\";\nimport { WPC } from \"../resources/Constants.js\";\nexport class Checksum {\n    static get stored() {\n        return ROM.byteAtAddr(ROM.nonPagedBankAddr + WPC.ChecksumOffset) * 256 + ROM.byteAtAddr(ROM.nonPagedBankAddr + WPC.ChecksumOffset + 1);\n    }\n    static _getRomDelta() {\n        return ROM.byteAtAddr(ROM.nonPagedBankAddr + WPC.DeltaOffset) * 256 + ROM.byteAtAddr(ROM.nonPagedBankAddr + WPC.DeltaOffset + 1);\n    }\n    static get calculated() {\n        let checksum = 0;\n        for (let i = 0; i < ROM.size; i++) {\n            checksum += ROM.byteAtAddr(i);\n        }\n        checksum %= 65536;\n        return checksum;\n    }\n    static get delta() {\n        return this._getRomDelta();\n    }\n    static _byteSumOf16bitVal(value) {\n        value &= 0xFFFF;\n        const highByte = (value >> 8) & 0xFF;\n        const lowByte = value & 0xFF;\n        return highByte + lowByte;\n    }\n    static _subtractChecksumAndDeltaBytes(checksum) {\n        const romDelta = this._getRomDelta();\n        const storedChecksum = this.stored;\n        return checksum - this._byteSumOf16bitVal(romDelta) - this._byteSumOf16bitVal(storedChecksum);\n    }\n    static disable() {\n        const romDelta = this._getRomDelta();\n        const romData = ROM.data;\n        let status = 0;\n        if ((romDelta != 0x00FF)) {\n            romData.set([0x00, 0xFF], ROM.nonPagedBankAddr + WPC.DeltaOffset);\n            status = 1;\n            logStr(\"ROM modified to disable checksum.\");\n        }\n        return { data: romData, status: status };\n    }\n    static update(version, force = false) {\n        version &= version;\n        version = parseInt(version.toString(), 16);\n        const romData = ROM.data;\n        const clearedChecksum = this._subtractChecksumAndDeltaBytes(this.calculated);\n        let newChecksum = 0;\n        let newDelta = 0;\n        let checksumFound = false;\n        let status = 0;\n        if (((this.stored == this.calculated) && version == (this.stored & 0xFF)) && !force) {\n            logStr(\"The checksum of the ROM is correct, no need to update\");\n            status = 0;\n        }\n        else {\n            logStr(\"Trying to figure out a new checksum and delta\");\n            for (let delta = this.delta; delta < 0xFFFF && !checksumFound; delta++) {\n                if (delta == 0x00FF) {\n                    delta = 0x2345;\n                }\n                for (let highByte = 0; highByte < 0xFF && !checksumFound; highByte++) {\n                    const checksum = (highByte << 8) + version;\n                    if ((clearedChecksum + this._byteSumOf16bitVal(delta) + highByte + version) == checksum) {\n                        checksumFound = true;\n                        newChecksum = checksum;\n                        newDelta = delta;\n                        romData.set([(newDelta >> 8) & 0xFF, newDelta & 0xFF], ROM.nonPagedBankAddr + WPC.DeltaOffset);\n                        romData.set([(newChecksum >> 8) & 0xFF, newChecksum & 0xFF], ROM.nonPagedBankAddr + WPC.ChecksumOffset);\n                        logStr(`New checksum is ${toHex(newChecksum)} and delta is ${toHex(newDelta)}`);\n                        status = 1;\n                    }\n                }\n            }\n            if (!checksumFound) {\n                logStr(`Error: Could not figure out a new checksum`);\n                status = -1;\n            }\n        }\n        return ({ data: romData, status: status });\n    }\n    static get isValid() {\n        return (this.calculated == this.stored);\n    }\n}\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}